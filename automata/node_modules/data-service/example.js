var express    = require('express');
var bodyParser = require('body-parser');
var app        = express();

var port = 5000;

var router = express.Router(); 	

app.use(express.static(__dirname + '/public'))

app.use(bodyParser());

app.use('/api/v1/', router);

app.listen(port);

var data_service = require('data-service');

process.on('uncaughtException', function (err) {
  console.log(err);
});

// MySQL Example
var mysql_config = require('./config/mysql.json');
// JSON To CSV
router.get("/example/mysql/json_to_csv", function(req, res) {
    var data = req.body;
    data_service.Read("mysql","listdata", {}, data ,function(data) {
        data_service.JSON2CSV(data,function(data) {
            res.setHeader('Content-disposition', 'attachment; filename=listdata.csv');
            res.writeHead(200, {
                'Content-Type': 'text/csv'
            });
            res.write(data);
            res.end();
        });
    });
});
// Update Config
router.post("/example/mysql/config", function(req, res) {
    var data = req.body;
    data_service.UpdateConfig("./config/mysql.json", data);
});
// Read Config
router.get("/example/mysql/config", function(req, res) {
    var data = req.body;
    data_service.ReadConfig("./config/mysql.json", function(data) {
        res.json(data);
    });
});
// Connect
data_service.Connect("mysql",mysql_config,function(data) {});
// Create
router.post("/example/mysql", function(req, res) {
    var data = req.body;
    data_service.Create("mysql","listdata", {ad_id: data.ad_id}, data ,function(data) {
        res.json(data);
    });
});
// Read
router.get("/example/mysql", function(req, res) {
    var data = req.query;
    var query = {};
    if ( data.ad_id != 'undefined' && data.ad_id != '' ) {
        query = {ad_id: data.ad_id};
    }
    data_service.Read("mysql","listdata", query, data ,function(data) {
        res.json(data);
    });
});
// Update
router.put("/example/mysql", function(req, res) {
    var data = req.body;
    data_service.Update("mysql","listdata", {ad_id: data.ad_id}, data ,function(data) {
        res.json(data);
    });
});
// Delete
router.delete("/example/mysql", function(req, res) {
    var data = req.body;
    data_service.Delete("mysql","listdata", {ad_id: data.ad_id}, data ,function(data) {
        res.json(data);
    });
});

// MongoDB Example
var mongodb_config = require('./config/mongodb.json');
data_service.Connect("mongodb",mongodb_config,function(data) {});
// JSON To CSV
router.get("/example/mongodb/json_to_csv", function(req, res) {
    var data = req.body;
    data_service.Read("mongodb","listdata", {}, data ,function(data) {
        data_service.JSON2CSV(data,function(data) {
            res.setHeader('Content-disposition', 'attachment; filename=listdata.csv');
            res.writeHead(200, {
                'Content-Type': 'text/csv'
            });
            res.write(data);
            res.end();
        });
    });
});

// Update Config
router.post("/example/mongodb/config", function(req, res) {
    var data = req.body;
    data_service.UpdateConfig("./config/mongodb.json",data);
});
// Read Config
router.get("/example/mongodb/config", function(req, res) {
    var data = req.body;
    data_service.ReadConfig("./config/mongodb.json", function(data) {
        res.json(data);
    });
});

// Create
router.post("/example/mongodb", function(req, res) {
    var data = req.body;
    console.log(data);
    data_service.Create("mongodb","listdata", {ad_id: data.ad_id} , data,function(data) {
        res.json(data);
    });
});
// Read
router.get("/example/mongodb", function(req, res) {
    var data = req.query;    
    var query = {};
    if ( data.ad_id != 'undefined' && data.ad_id != '' ) {
        query = {ad_id: data.ad_id};
    }
    data_service.Read("mongodb","listdata", query, data, function(data) {
        res.json(data);
    });
});
// Update
router.put("/example/mongodb", function(req, res) {
    var data = req.body;
    data_service.Update("mongodb","listdata", {ad_id: data.ad_id} , data ,function(data) {
        res.json(data);
    });
});
// Delete
router.delete("/example/mongodb", function(req, res) {
    var data = req.body;
    data_service.Delete("mongodb","listdata", {ad_id: data.ad_id} , data ,function(data) {
        res.json(data);
    });
});

